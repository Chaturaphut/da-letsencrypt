#!/usr/local/bin/php
<?php
use DirectAdmin\LetsEncrypt\Lib\HTTPSocket;

require_once dirname(__DIR__) . '/includes/bootstrap.php';
?>

<table class="list" cellspacing="1" cellpadding="3">
    <tr>
        <td class=listtitle colspan=2>Request a SSL certificate</td>
    </tr>

    <form action="/CMD_PLUGINS/da-letsencrypt/actions/request.html" method="POST">
        <tr>
            <td class="list">Domain</td>
            <td class=list><?= $_SERVER['SESSION_SELECTED_DOMAIN']; ?></td>
        </tr>
        <tr>
            <td class="list">Subdomains</td>
            <td class=list>
                <?php

                $sock = new HTTPSocket();
                $sock->connect('127.0.0.1', 2222);
                $sock->set_login('admin');
                $sock->set_method('POST');
                $sock->query('/CMD_API_SUBDOMAIN', [
                    'domain' => $_SERVER['SESSION_SELECTED_DOMAIN']
                ]);
                $result = $sock->fetch_parsed_body();

                echo '<input type="checkbox" name="subdomains[]" value="www.' . $_SERVER['SESSION_SELECTED_DOMAIN'] .'" checked="checked" /> www.' . $_SERVER['SESSION_SELECTED_DOMAIN'] .'<br/>';

                foreach($result['list'] as $subdomain) {
                    $subdomain = $subdomain . '.' . $_SERVER['SESSION_SELECTED_DOMAIN'];

                    echo '<input type="checkbox" name="subdomains[]" value="' . $subdomain . '" checked="checked" /> ' . $subdomain .'<br/>';
                    echo '<input type="checkbox" name="subdomains[]" value="www.' . $subdomain . '" checked="checked" /> www.' . $subdomain .'<br/>';
                }
                ?>
            </td>
        </tr>
        <tr>
            <td class="list">E-mail Address</td>
            <td class=list>
                <input type="text" name="email" value="" /> (e.g. example@domain.com)
            </td>
        </tr>
        <tr>
            <td class="listtitle" align="right" colspan="6">
                <input type="checkbox" name="accept_tos" onclick="document.getElementsByClassName('submit_accept_tos')[0].disabled = !this.checked;">
                I accept the <a href="https://letsencrypt.org/repository/" target="_blank">Terms of Service</a> of Let's Encrypt.

                <input type="submit" class="submit_accept_tos" disabled="disabled">
            </td>
        </tr>
    </form>
</table>


